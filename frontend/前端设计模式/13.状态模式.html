<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>状态模式 | caomey</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/vuepress-blog/IronMan.jpg">
    <link rel="manifest" href="/vuepress-blog/manifest.json">
    <link rel="apple-touch-icon" href="/vuepress-blog/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/vuepress-blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.273a7b0f.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.1fefe163.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.b8fbb471.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/119.3ff27d52.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/3.8cc36801.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.cd279dbb.js"><link rel="prefetch" href="/vuepress-blog/assets/js/100.c0fb210e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/101.8d30554e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/102.8a0cf9d4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/103.291ac59a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/104.cbe3afa8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/105.c56882ff.js"><link rel="prefetch" href="/vuepress-blog/assets/js/106.cda2d11f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/107.4750ce59.js"><link rel="prefetch" href="/vuepress-blog/assets/js/108.6bd8711c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/109.8963da31.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.536a6c81.js"><link rel="prefetch" href="/vuepress-blog/assets/js/110.718eba1e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/111.ddee2a4f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/112.d7983abc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/113.bd6c9eaa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/114.5837fc08.js"><link rel="prefetch" href="/vuepress-blog/assets/js/115.3a6460b0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/116.e5fab2da.js"><link rel="prefetch" href="/vuepress-blog/assets/js/117.ba8f4c79.js"><link rel="prefetch" href="/vuepress-blog/assets/js/118.2b4a3197.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.434382aa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/120.132a3b78.js"><link rel="prefetch" href="/vuepress-blog/assets/js/121.5dbfe861.js"><link rel="prefetch" href="/vuepress-blog/assets/js/122.8385dd7c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/123.72b73cc7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/124.e131c72c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/125.a37ecd68.js"><link rel="prefetch" href="/vuepress-blog/assets/js/126.e72a7d82.js"><link rel="prefetch" href="/vuepress-blog/assets/js/127.d66a2a19.js"><link rel="prefetch" href="/vuepress-blog/assets/js/128.d2bbbe9a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/129.3e2a0852.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.fb36c840.js"><link rel="prefetch" href="/vuepress-blog/assets/js/130.bcfb0fa6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/131.2cfd46af.js"><link rel="prefetch" href="/vuepress-blog/assets/js/132.6f2e8b4e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/133.ae9c691c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/134.702e47f0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/135.5a30dc50.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.ad2e8bac.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.0f97ae19.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.3b6376b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.31b1fa2c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.f86cdf82.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.53cdc9aa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.5a4bbd54.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.b99ff10c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.f99fe9ba.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.10dc7fca.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.d230860c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.9c3b581e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.a8de871f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.f5ed37c9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.e8964090.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.955cbeb7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.0687291f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.e2d55fe8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.0dbb88b9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.30b6b38d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.2f7312c1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.c1b415cc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.4beeae64.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.e1388faa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.69a20638.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.52e7e99c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.e9822a5e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.eec866eb.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.edd49088.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.dcefeead.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.a150f1f8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.0897b967.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.92014b01.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.88f2b7d5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.7a7996d1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.7bd7e4a9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.3cb9f71b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.b62578dd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.041863a4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.6e4bbbd6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.1216a3e8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.0bc84fb7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.446406fd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.cb8a10d9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.bd7ec791.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.a2be869f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.49b32794.js"><link rel="prefetch" href="/vuepress-blog/assets/js/59.d0e84679.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.308ae663.js"><link rel="prefetch" href="/vuepress-blog/assets/js/60.b463cf62.js"><link rel="prefetch" href="/vuepress-blog/assets/js/61.18ea4a28.js"><link rel="prefetch" href="/vuepress-blog/assets/js/62.82840815.js"><link rel="prefetch" href="/vuepress-blog/assets/js/63.5f7fe631.js"><link rel="prefetch" href="/vuepress-blog/assets/js/64.5f07afaa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/65.51714dd5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/66.fa2ffdde.js"><link rel="prefetch" href="/vuepress-blog/assets/js/67.fa6a9559.js"><link rel="prefetch" href="/vuepress-blog/assets/js/68.a06bf7a5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/69.c8ffa604.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.fba07196.js"><link rel="prefetch" href="/vuepress-blog/assets/js/70.e38e605d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/71.fdf3b49e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/72.c66075d5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/73.27a73b1b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/74.dbff0f08.js"><link rel="prefetch" href="/vuepress-blog/assets/js/75.9ad98215.js"><link rel="prefetch" href="/vuepress-blog/assets/js/76.8606dd05.js"><link rel="prefetch" href="/vuepress-blog/assets/js/77.01831823.js"><link rel="prefetch" href="/vuepress-blog/assets/js/78.c55073af.js"><link rel="prefetch" href="/vuepress-blog/assets/js/79.25c7ced6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.3b8959ce.js"><link rel="prefetch" href="/vuepress-blog/assets/js/80.d390edc0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/81.934f3df7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/82.15582332.js"><link rel="prefetch" href="/vuepress-blog/assets/js/83.b8766bab.js"><link rel="prefetch" href="/vuepress-blog/assets/js/84.9e6253f7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/85.716ae9a2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/86.cfd1aaf1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/87.ba389498.js"><link rel="prefetch" href="/vuepress-blog/assets/js/88.2f7a76da.js"><link rel="prefetch" href="/vuepress-blog/assets/js/89.57c56027.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.8dc45838.js"><link rel="prefetch" href="/vuepress-blog/assets/js/90.a9cdbd1d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/91.c588a160.js"><link rel="prefetch" href="/vuepress-blog/assets/js/92.bfa64f4c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/93.601d0901.js"><link rel="prefetch" href="/vuepress-blog/assets/js/94.fabea959.js"><link rel="prefetch" href="/vuepress-blog/assets/js/95.980ea76f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/96.e35c0be4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/97.c95cd61e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/98.84d23e7f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/99.b411d56b.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.273a7b0f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">caomey</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/guide/" class="nav-link">
  GUIDE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/javascript底层机制/" class="nav-link">
  javascript底层机制
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/html/" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vuepress/" class="nav-link">
  vuepress
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vue-cli/" class="nav-link">
  vue-cli
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Vuex/" class="nav-link">
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vueRouter/" class="nav-link">
  vueRouter
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Node.js/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/codepen/" class="nav-link">
  codepen
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/others/" class="nav-link">
  others
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/前端设计模式/" class="nav-link">
  Design Patterns
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/codename/" class="nav-link">
  codename
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/UI/" class="nav-link">
  UI
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/算法题/" class="nav-link">
  算法题
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Vscode/" class="nav-link">
  Vscode
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/函数式编程/" class="nav-link">
  函数式编程
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/caomey?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/guide/" class="nav-link">
  GUIDE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/javascript底层机制/" class="nav-link">
  javascript底层机制
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/html/" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vuepress/" class="nav-link">
  vuepress
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vue-cli/" class="nav-link">
  vue-cli
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Vuex/" class="nav-link">
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/vueRouter/" class="nav-link">
  vueRouter
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Node.js/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/codepen/" class="nav-link">
  codepen
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/others/" class="nav-link">
  others
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/前端设计模式/" class="nav-link">
  Design Patterns
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/codename/" class="nav-link">
  codename
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/UI/" class="nav-link">
  UI
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/算法题/" class="nav-link">
  算法题
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/Vscode/" class="nav-link">
  Vscode
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/frontend/函数式编程/" class="nav-link">
  函数式编程
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/caomey?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/frontend/前端设计模式/1.单例模式.html" class="sidebar-link">单例模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/10.职责链模式.html" class="sidebar-link">职责链模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/12.装饰者模式.html" class="sidebar-link">装饰者模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/13.状态模式.html" class="active sidebar-link">状态模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/14.适配器模式.html" class="sidebar-link">适配器模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/2.策略模式.html" class="sidebar-link">策略模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/3.代理模式.html" class="sidebar-link">代理模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/4.迭代器模式.html" class="sidebar-link">迭代器模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/5.观察者模式.html" class="sidebar-link">发布订阅模式(观察者模式)</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/6.命令模式.html" class="sidebar-link">命令模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/7.组合模式.html" class="sidebar-link">组合模式</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/9.亨元模式.html" class="sidebar-link">享元模式</a></li><li><a href="/vuepress-blog/frontend/%E5%89%8D%E7%AB%AF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" aria-current="page" class="sidebar-link">/frontend/%E5%89%8D%E7%AB%AF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/封装.html" class="sidebar-link">封装(信息隐藏)</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/设计原则.html" class="sidebar-link">设计原则和编程技巧</a></li><li><a href="/vuepress-blog/frontend/前端设计模式/设计模式.html" class="sidebar-link">设计模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="状态模式"><a href="#状态模式" class="header-anchor">#</a> 状态模式</h1> <p>状态模式的关键是区分事物内部的状态，事物内部状态的改变往往会带来事物的行为改变；</p> <h4 id="_13-1-初识状态模式-电灯程序"><a href="#_13-1-初识状态模式-电灯程序" class="header-anchor">#</a> 13.1 初识状态模式-电灯程序</h4> <blockquote><ol><li>开关控制电灯的打开关闭状态；</li></ol></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'off'</span><span class="token punctuation">;</span> <span class="token comment">// 给电灯设置初始状态 off</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 电灯开关按钮</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 定义 Light.prototype.init 方法</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'button'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'开关'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> button <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> self<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 开关按下操作</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'off'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'on'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'on'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'关灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'off'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的例子使用一个变量 <code>state</code> 来记录按钮的当前状态，在事件发生时，再根据这个状态来决定下一步的行为；不过当电灯的状态增加时（如强光，弱光状态等），需要手动修改 <code>buttonWasPressed</code> 函数，这样就是违反程序的<code>开放-封闭原则</code>，状态之间的切换关系是在 <code>buttonWasPressed</code> 函数增加 <code>if-else</code> 判断，当状态很多时， <code>buttonWasPressed</code> 函数会更加难以阅读和维护；</p> <blockquote><ol><li>状态模式改进电灯程序：</li></ol></blockquote> <p>状态模式的关键是把事物的每种状态都封装成单独的类，跟此种状态有关的行为都被封装在这个类的内部，所以 <code>button</code> 被按下的的时候，只需要在上下文中，把这个请求委托给当前的状态对象即可，该状态对象会负责渲染它自身的行为；</p> <p><img src="https:////upload-images.jianshu.io/upload_images/14756387-19ea8fe01c74d7b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/528/format/webp" alt="img"></p> <p>_状态模式电灯_1576651917_24154.png</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 首先将定义 3 个状态类，分别是 offLightState(关灯状态)、WeakLightState(弱光状态)、 strongLightState(强光状态) ,每个类都有一个原型方法 buttonWasPressed，代表在各自状态下点击按钮发送的行为；</span>
<span class="token keyword">var</span> <span class="token function-variable function">OffLightState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">light</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">OffLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'弱光'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// offLightState 对应的行为</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>weakLightState <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换状态到 weakLightState</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">WeakLightState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">light</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">WeakLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'强光'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// weakLightState 对应的行为</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>strongLightState <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换状态到 strongLightState</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">StrongLightState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">light</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">StrongLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'关灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// strongLightState 对应的行为</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>offLightState <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换状态到 offLightState</span>
<span class="token punctuation">}</span>
<span class="token comment">// Light 类：在构造函数里为每个状态类都创建一个状态对象</span>
<span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>offLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>weakLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>strongLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrongLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Light 初始化方法</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'button'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> button <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'开关'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offLightState<span class="token punctuation">;</span> <span class="token comment">// 设置当前电灯状态为关灯</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 按钮被按下的事件请求委托给当前持有的状态对象去执行</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 实现 Light.prototype.setState 方法：状态对象可以通过这个方法来切换 light 对象的状态，状态的切换规律事先被完好定义在各个状态类中；</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">newState</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 测试效果</span>
<span class="token keyword">var</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>状态模式可以使每一种状态和它对应的行为之间的关系局部化，这些行为被分散和封装在各自对应的状态类之中，便于阅读和管理代码；状态之间的切换都被分布在状态类内部，这使得我们无需编写过多的 <code>if-else</code> 条件分支语言来控制状态之间的转换；</p> <p>上面例子中若需要为 <code>light</code> 对象增加一种新的状态时，只需要增加一个新的状态类，再稍稍改变一些现有的代码即可；若现在 light 对象多了一种超强光的状态，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先增加 SuperStrongLightState 类；</span>
<span class="token keyword">var</span> <span class="token function-variable function">SuperStrongLightState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">light</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">SuperStrongLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'关灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>offLightState <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 再在 Light 构造函数里新增一个 superStrongLightState 对象：</span>
<span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>offLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>weakLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>strongLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrongLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>superStrongLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperStrongLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增 superStrongLightState 对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 最后改变状态类之间的切换规则，从 StrongLightState----&gt;OffLightState 变为 StrongLightState----&gt;SuperStrongLightState ----&gt;OffLightState：</span>
<span class="token class-name">StrongLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'超强光'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// strongLightState 对应的行为</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>superStrongLightState <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换状态到 offLightState</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_13-2-状态模式的通用结构"><a href="#_13-2-状态模式的通用结构" class="header-anchor">#</a> 13.2 状态模式的通用结构</h4> <p>在电灯的例子中，首先定义了 <code>Light</code> 类， Light类在这里也被称为上下文（ <code>Context</code> ）；随后在 <code>Light</code> 的构造函数中创建每一个状态类的实例对象， <code>Context</code> 将持有这些状态对象的引用，以便把请求委托给状态对象；用户的请求，即点击 <code>button</code> 的动作也是实现在 <code>Context</code> 中的，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>offLightState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffLightState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持有状态对象的引用</span>
  <span class="token operator">...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'button'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> button <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'开关'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offLightState<span class="token punctuation">;</span> <span class="token comment">// 设置默认初始状态</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 定义用户的请求动作  </span>
    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来要编写各种状态类， <code>light</code> 对象被传入状态类的构造函数，状态对象也需要持有 <code>light</code> 对象的引用，以便调用 <code>light</code> 中的方法或者直接操作 <code>light</code> 对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">OffLightState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">light</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">OffLightState</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">buttonWasPressed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'弱光'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>weakLightState <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><h4 id="_13-3-状态模式示例-文件上传"><a href="#_13-3-状态模式示例-文件上传" class="header-anchor">#</a> 13.3 状态模式示例——文件上传</h4> <p>文件上传中，包括有扫描、正在上传、暂停、上传成功、上传失败这几种状态，点击同一个按钮，在上传中和
暂停状态下的行为表现是不一样的，如上传中，点击按钮暂停，暂停中，点击按钮继续播放；</p> <p>文件上传中，设置 暂停/继续 和 删除两个按钮，点击这两个按钮的发生行为如下：</p> <ul><li>文件在扫描状态中，是不能进行任何操作的，既不能暂停也不能删除文件，只能等待扫描完成。扫描完成之后，根据文件的 md5 值判断，若确认该文件已经存在于服务器，则直接跳到上传完成状态。如果该文件的大小超过允许上传的最大值，或者该文件已经损坏，则跳往上传失败状态。剩下的情况下才进入上传中状态；</li> <li>上传过程中可以点击暂停按钮来暂停上传，暂停后点击同一个按钮会继续上传；</li> <li>扫描和上传过程中，点击删除按钮无效，只有在暂停、上传完成、上传失败之后，才能删除文件；</li></ul> <blockquote><ol><li>文件上传基本实现：</li></ol></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 上传是一个异步的过程，定义全局函数 window.external.upload 来通知上传进度，把当前的文件状态作为参数state 传入函数中</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function-variable function">upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">state</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> state <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可能为 sign、 uploading、 done、 error</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 上传的插件对象</span>
<span class="token keyword">var</span> plugin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> plugin <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'embed'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/txftn-webkit'</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开始文件扫描'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">pause</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'暂停文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">uploading</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开始文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'删除文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件上传完成'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> plugin <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> plugin<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义控制上传过程的对象 Upload 类</span>
<span class="token keyword">var</span> <span class="token function-variable function">Upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">fileName</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin <span class="token operator">=</span> plugin<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'sign'</span><span class="token punctuation">;</span> <span class="token comment">// 设置初始状态为 waiting</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化 Upload 类函数</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'div'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
    <span class="token string">'&lt;span&gt;文件名称:'</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">+</span><span class="token string">'&lt;/span&gt;\
    &lt;button data-action=&quot;button1&quot;&gt;扫描中&lt;/button&gt;\
    &lt;button data-action=&quot;button2&quot;&gt;删除&lt;/button&gt;'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span> <span class="token string">'[data-action=&quot;button1&quot;]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个按钮</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span> <span class="token string">'[data-action=&quot;button2&quot;]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二个按钮</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 两个按钮分别绑定点击事件</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'sign'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 扫描状态下，任何操作无效</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'扫描中，点击无效...'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'uploading'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 上传中，点击切换到暂停</span>
      self<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span> <span class="token string">'pause'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pause'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 暂停中，点击切换到上传中</span>
      self<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span> <span class="token string">'uploading'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'done'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件已完成上传, 点击无效'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'error'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件上传失败, 点击无效'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'done'</span> <span class="token operator">||</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'error'</span> <span class="token operator">||</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pause'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 上传完成、上传失败和暂停状态下可以删除</span>
      self<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span> <span class="token string">'del'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'sign'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件正在扫描中，不能删除'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'uploading'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件正在上传中，不能删除'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Upload.prototype.changeState 方法，负责切换状态之后的具体行为：</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">changeState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">state</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span> state <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'sign'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'扫描中，任何操作无效'</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'uploading'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">uploading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'正在上传，点击暂停'</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'pause'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'已暂停，点击继续上传'</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'done'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'上传完成'</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'error'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'上传失败'</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'del'</span><span class="token operator">:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'删除完成'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 测试上传文件</span>
<span class="token keyword">var</span> uploadObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span> <span class="token string">'JavaScript 设计模式与开发实践'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
uploadObj<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function-variable function">upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">state</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 插件调用 JavaScript 的方法</span>
  uploadObj<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span> state <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'sign'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件开始扫描</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'uploading'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 秒后开始上传</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'done'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 秒后上传完成</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><ol><li>状态模式重构文件上传程序：</li></ol></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一步：提供 window.external.upload 函数</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function-variable function">upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">state</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> state <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可能为 sign、 uploading、 done、 error</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> plugin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> plugin <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'embed'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/txftn-webkit'</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开始文件扫描'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">pause</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'暂停文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">uploading</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开始文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'删除文件上传'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  plugin<span class="token punctuation">.</span><span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件上传完成'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> plugin <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> plugin<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 第二步：改造 Upload 构造函数，在构造函数中为每种状态子类都创建一个实例对象</span>
<span class="token keyword">var</span> <span class="token function-variable function">Upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">fileName</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin <span class="token operator">=</span> plugin<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>signState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置初始状态为 waiting</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadingState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadingState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pauseState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PauseState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>doneState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoneState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>errorState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorState</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>signState<span class="token punctuation">;</span> <span class="token comment">// 设置当前状态</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 第三步：实现 Upload.prototype.init 方法</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'div'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
    <span class="token string">'&lt;span&gt;文件名称:'</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">+</span><span class="token string">'&lt;/span&gt;\
    &lt;button data-action=&quot;button1&quot;&gt;扫描中&lt;/button&gt;\
    &lt;button data-action=&quot;button2&quot;&gt;删除&lt;/button&gt;'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span> <span class="token string">'[data-action=&quot;button1&quot;]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span> <span class="token string">'[data-action=&quot;button2&quot;]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 第四步：负责具体的按钮事件实现</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">clickHandler1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button2<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">clickHandler2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>signState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">uploading</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'正在上传，点击暂停'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">uploading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadingState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pause</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'已暂停，点击继续上传'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pauseState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'上传完成'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>doneState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'上传失败'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>errorState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugin<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 第五步：编写各个状态类的实现</span>
<span class="token keyword">var</span> StateFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">State</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">State</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">clickHandler1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span> <span class="token string">'子类必须重写父类的 clickHandler1 方法'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">State</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">clickHandler2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span> <span class="token string">'子类必须重写父类的 clickHandler2 方法'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">param</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">uploadObj</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj <span class="token operator">=</span> uploadObj<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token keyword">in</span> param <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">F</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span> i <span class="token punctuation">]</span> <span class="token operator">=</span> param<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">F</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> SignState <span class="token operator">=</span> <span class="token function">StateFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">clickHandler1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'扫描中，点击无效...'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">clickHandler2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件正在上传中，不能删除'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> UploadingState <span class="token operator">=</span> <span class="token function">StateFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">clickHandler1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">clickHandler2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件正在上传中，不能删除'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> PauseState <span class="token operator">=</span> <span class="token function">StateFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">clickHandler1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj<span class="token punctuation">.</span><span class="token function">uploading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">clickHandler2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> DoneState <span class="token operator">=</span> <span class="token function">StateFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">clickHandler1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件已完成上传, 点击无效'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">clickHandler2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ErrorState <span class="token operator">=</span> <span class="token function">StateFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">clickHandler1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'文件上传失败, 点击无效'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">clickHandler2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadObj<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最后测试</span>
<span class="token keyword">var</span> uploadObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span> <span class="token string">'JavaScript 设计模式与开发实践'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
uploadObj<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function-variable function">upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">state</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> uploadObj<span class="token punctuation">[</span> state <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'sign'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'uploading'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 秒后开始上传</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span> <span class="token string">'done'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 秒后上传完成</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_13-4-状态模式的优缺点及性能优化点"><a href="#_13-4-状态模式的优缺点及性能优化点" class="header-anchor">#</a> 13.4 状态模式的优缺点及性能优化点</h4> <blockquote><ol><li>状态模式的优点：</li></ol></blockquote> <ul><li>状态模式定义了状态与行为之间的关系，并将它们封装在一个类里，通过增加新的状态类，很容易增加新的状态和转换；</li> <li>避免 <code>Context</code> 无限膨胀，状态切换的逻辑被分布在状态类中，也去掉了 <code>Context</code> 中原本过多的条件分支；</li> <li>用对象代替字符串来记录当前状态，使得状态的切换更加一目了然；</li> <li><code>Context</code> 中的请求动作和状态类中封装的行为可以非常容易地独立变化而互不影响；</li></ul> <blockquote><ol><li>状态模式的缺点：</li></ol></blockquote> <p>状态模式会在系统中定义许多状态类，并且生成许多对象；同时由于逻辑分散在状态类中，虽然减少了 <code>if-else</code>分支语句，但也造成了逻辑分散的问题；</p> <blockquote><ol><li>状态模式性能优化点：</li></ol></blockquote> <ul><li>有两种选择来管理 <code>state</code> 对象的创建和销毁，第一种是仅当 <code>state</code> 对象被需要时才创建并随后销毁，能有效的节省内存；另一种是一开始就创建好所有的状态对象，并且始终不销毁它们，适用于状态的改变很频繁的场景中；</li> <li>本章的例子中，为每个 <code>Context</code> 对象都创建了一组 <code>state</code> 对象，实际上这些 <code>state</code> 对象之间是可以共享的，各 <code>Context</code> 对象可以共享一个 <code>state</code> 对象，这也是享元模式的应用场景之一；</li></ul> <h4 id="_13-5-状态模式和策略模式的关系"><a href="#_13-5-状态模式和策略模式的关系" class="header-anchor">#</a> 13.5 状态模式和策略模式的关系</h4> <p>状态模式和策略模式都封装了一系列的算法或者行为，它们的类图看起来来几乎一模一样，但在意图上有很大不同，因此它们是两种迥然不同的模式；策略模式和状态模式的相同点是都有一个上下文、一些策略或者状态类，上下文把请求委托给这些类来执行；区别是策略模式中的各个策略类之间是平等又平行的，它们之间没有任何联系，所以必须熟知这些策略类的作用，以便可以随时主动切换算法；而在状态模式中，状态和状态对应的行为是早已被封装好的，状态之间的切换也早被规定完成，“改变行为”这件事情发生在状态模式内部，因此我们不需要了解这些细节；</p> <h4 id="_13-6-javascript-版本的状态机"><a href="#_13-6-javascript-版本的状态机" class="header-anchor">#</a> 13.6 JavaScript 版本的状态机</h4> <p>前面示例都是模拟传统面向对象语言的状态模式实现，为每种状态都定义一个状态子类，然后在 <code>Context</code> 中持有这些状态对象的引用，以便把 <code>currState</code> 设置为当前的状态对象；在 JavaScript 这种“无类”语言中，没有规定让状态对象一定要从类中创建而来。另外， JavaScript 可以非常方便地使用委托技术，并不需要事先让一个对象持有另一个对象。</p> <p>下面的状态机选择了通过 <code>Function.prototype.call</code> 方法直接把请求委托给某个字面量对象来执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 方式1</span>
<span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>off<span class="token punctuation">;</span> <span class="token comment">// 设置当前状态</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'button'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'已关灯'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> button <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> self <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把请求委托给 FSM 状态机</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">FSM</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  off<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'关灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是开灯'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>on<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  on<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是关灯'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>off<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 方式2：利用下面的 delegate 函数来完成这个状态机编写。这是面向对象设计和闭包互换的一个例子，前者把变量保存为对象的属性，而后者把变量封闭在闭包形成的环境</span>
<span class="token keyword">var</span> <span class="token function-variable function">delegate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">client<span class="token punctuation">,</span> delegation</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 将客户的操作委托给 delegation 对象</span>
      <span class="token keyword">return</span> delegation<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> client<span class="token punctuation">,</span> arguments <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">FSM</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  off<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'关灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是开灯'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  on<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'开灯'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是关灯'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>offState <span class="token operator">=</span> <span class="token function">delegate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>off <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onState <span class="token operator">=</span> <span class="token function">delegate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>on <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offState<span class="token punctuation">;</span> <span class="token comment">// 设置初始状态为关闭状态</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">'button'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'已关灯'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span> button <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_13-7-状态模式小结"><a href="#_13-7-状态模式小结" class="header-anchor">#</a> 13.7 状态模式小结</h4> <p>状态模式是非常有效的模式之一，通过状态模式重构代码之后，会让代码会变得清晰。虽然状态模式一开始并不是非常容易理解，但有必须去好好掌握这种设计模式。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">7/16/2020, 9:57:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/frontend/前端设计模式/12.装饰者模式.html" class="prev">
        装饰者模式
      </a></span> <span class="next"><a href="/vuepress-blog/frontend/前端设计模式/14.适配器模式.html">
        适配器模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vuepress-blog/assets/js/app.1fefe163.js" defer></script><script src="/vuepress-blog/assets/js/2.b8fbb471.js" defer></script><script src="/vuepress-blog/assets/js/119.3ff27d52.js" defer></script><script src="/vuepress-blog/assets/js/3.8cc36801.js" defer></script>
  </body>
</html>
